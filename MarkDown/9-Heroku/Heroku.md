
- [Heroku && MongoDB](#heroku--mongodb)
  - [Настройка MongoDB](#настройка-mongodb)
    - [***Создание аккаунта и БД:***](#создание-аккаунта-и-бд)
    - [***Создание самой БД внутри кластера:***](#создание-самой-бд-внутри-кластера)
  - [Heroku](#heroku)
    - [***Установка и подключение:***](#установка-и-подключение)
    - [***Node JS в связке с React:***](#node-js-в-связке-с-react)

# Heroku && MongoDB


**heroku.com** - это бесплатный хостинг, на который можно залить проект с БД, нодой, реактом и почти всё что угодно. 

Самое главное, чтобы был файл `package.json` в самом проекте, который и устанавливает все необходимые модули и настройки в проект. Без него работать не будет.
***

## Настройка MongoDB

В обычном проекте на БД запускатеся локально на компе. Поскольку `heroku` - это удаленный сайт, то там нельзя запустить БД также, как на компе.

### ***Создание аккаунта и БД:***
Заливаем БД глобально, на сайте: https://cloud.mongodb.com

1. Регистрируемся и авторизируемся. 
2. Выбираем поставщика облака, регион и бесплатный план "Песочница M0", после чего подтверждаем создание кластера.
3. Ждем 3 минуты установки.
4. Создаём нового юзера:
![](image/photo_2021-05-06_16-27-55.jpg)
![](/image/photo_2021-05-06_16-27-30.jpg)
5. Вносим в белый список свой IP-адрес, с которого будет подключение облака. Для `heroku` отдельно нужно внести адрес `0.0.0.0/0` (все адреса) как разрешенные:
![](image/photo_2021-05-06_16-29-39.jpg)
6. Подключаем локальную БД к облаку по выбранному методу (нужно 2, для своих проектов):
![](/image/photo_2021-05-06_16-33-23.jpg)
7. И коннектимся к БД из `app.js` либо по предлагаемому коду на скрине, либо по собственному методу:
![](image/photo_2021-05-06_16-43-30.jpg)
8. Само подключение в `app.js` происходит по тому паролю, который указывался конкретно к созданному юзеру (пункт 4, 2-й скриншот): 
    * адрес примерно такой: `'mongodb+srv://Chat:MyPassword@cluster0.pyfv2.mongodb.net/ChatRoomsReact?retryWrites=true&w=majority'`


### ***Создание самой БД внутри кластера:***

Поскольку в монге для того, чтобы БД была видна в ней нужно создать коллекцию - то так и поступаем и создаём коллекцию в этом облаке, если нужно создать с нуля:

![](image/photo_2021-05-06_16-51-19.jpg)

![](image/photo_2021-05-06_16-54-50.jpg)
***

## Heroku 


### ***Установка и подключение:***
Для начала нужно установить приложение из AUR: `heroku-cli`

Пока оно устанавливается - регистрируем аккаунт на **heroku.com**

Затем создаём общую папку, где буду храниться проекты. Каждый отдельный проект - отдельный домен в `heroku`.

К примерую имеем следующую структуру:

```bash
Heroku projects
    Chat
    Calendar
```

Заходим в папку Chat, открываем в ней терминал и делаем следующее:

1. `heroku login` - нажимаем любую кнопку и авторизируемся.
2. `heroku create` - создаём новый проект на сайте и по итогу выдаст две ссылки: на сам проект и на гит проекта.
3. И дальше по накатанной, как в гите: 
    ```bash
   git init
   git add .
   git commit -m "true"
   heroku git:remote -a dry-anchorage-87272
   git push heroku master
   ```
4. Вводим `heroku open` чтобы узнать ссылку на проект и заходим.


Из базовых команд: `heroku restart`, перезапускает проект. 

### ***Node JS в связке с React:***

Во первых помним, что React запускается по дефолту на `localhost:3000`, а Node JS на любом другом порте. 

В **heroku** первоначально должен показываться сам React, который просто проксирует свои запросы на порт сервера. Также запуск проекта по дефолту и автоматически производится командой `npm run start`, т.е. никаких `npm run dev` быть не может.

Порядок действий следующий:
1. В папке React ищем `package.json` и прописываем следующее: 
    * `"proxy": "http://localhost:5000` (порт сервера).
2. В самом сервере `package.json` прописываем следующую структуру в `"scripts"`:
    ```json
    "scripts": {
        "start": "node app.js",
        "client": "npm start --prefix client",
        "client-install": "npm install --prefix client",
        "dev": "concurrently \"npm run start\"  \"npm run client\"",
        "heroku-postbuild": "NPM_CONFIG_PRODUCTION=false npm install --prefix client && npm run build --prefix client "
    },
    ```
    * `"heroku-postbuild"` сначала устанавливает пакеты папки `client` и затем устанавливает модуль `build` (динамический файл html для подключения в ноде).
3. Далее в `app.js` прописываем следующий код, который будет показывать динамический файл **HTML**:
    ```js

    if (process.env.NODE_ENV === 'production') {
        app.use(express.static(path.join(__dirname, 'client/build')))
        app.get('*', (req, res) => {
            res.sendFile(path.resolve(__dirname, 'client', 'build', 'index.html'))
        })
    }

    app.get('*', (req, res) => {
      res.sendFile(path.resolve(__dirname, 'client', 'public', 'index.html'))
    })
    ```
    * Если динамический процесс React в папке Build существует - то рендерить файл на лету.
    * Если его нет - показать статичный файл.

И собственно это все подводные камни. После настройки проект будет работать как нужно!