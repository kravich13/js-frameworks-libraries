- [Промежуточные обработчики](#промежуточные-обработчики)
  - [Промежуточный обработчик уровня приложения](#промежуточный-обработчик-уровня-приложения)
  - [Промежуточный обработчик для обработки ошибок](#промежуточный-обработчик-для-обработки-ошибок)

# Промежуточные обработчики

Промежуточные обработчики - это функции, имеющие доступ к объекту запроса (`req`), объекту ответа (`res`) и к следующей функции промежуточной обработке в цикле "запрос-ответ" приложения (`next`).

Функции промежуточной обработки могут выполнять следующие задачи: 
* Выполнение любого кода.
* Внесение изменений в объекты запросов и ответов.
* Завершение цикла “запрос-ответ”.
* Вызов следующей функции промежуточной обработки из стека.

Если текущая функция промежуточной обработки не завершает цикл “запрос-ответ”, она должна вызвать `next()` для передачи управления следующей функции промежуточной обработки. В противном случае запрос зависнет.
***

## Промежуточный обработчик уровня приложения

Промежуточная функция обработки без пути монтирования, выполняется при каждом получении запроса приложением.

```javascript
const app = express()

app.use(function (req, res, next) {
  console.log(`Time: ${Date.now()}`)
  next()
})
```

Функция промежуточной обработки, монтируемая в указанный путь. Выполняется для всех типов запросов HTTP в указанном пути:

```javascript
app.use("/user/:id", function (req, res, next) {
  console.log(`Request Type: ${req.method}`)
  next()
})
```

Последовательность функций промежуточной обработки в точку монтирования с указанием пути монтирования:

```javascript
app.use("/user/:id", function(req, res, next) {
  console.log(`Request URL: ${req.originalUrl}`) // 1)
  next()
}, function (req, res, next) {
  console.log(`Request Type: ${req.method}`) // 2)
  next()
})
```

Обработчики маршрутов позволяют определить несколько маршрутов одного пути. В примере ниже есть два маршрута для пути, первый - цикл "запрос-ответ", второй обычный, но второй никогда не выполнится потому что существует цикл:

```javascript
app.get("/user/:id", function (req, res, next) { // 1)
    console.log(`ID: ${req.params.id}`)
    next()
  }, function (req, res, next) {
    res.send('User Info')
})
  
 app.get('/user/:id', function (req, res, next) { // 2)
    res.end(req.params.id) // никогда не выполнится ибо цикл "запрос-ответ" сверху окончен
 })
```
***

## Промежуточный обработчик для обработки ошибок

Обработчик ошибок всегда содержит 4 аргумента: 

```javascript
app.use(function (err, req, res, next) {
  console.log(err.stack)
  res.status(500).send("Поломка")
})
```

Обработчик должен быть определен последним, после указания всех `app.use()` и вызовов маршрутов: 

```javascript
const bodyParser = require('body-parser')
const methodOverride = require('method-override')

app.use(bodyParser())
app.use(methodOverride())
app.use(function(err, req, res, next) {
  // logic
})
```

Также можно передать ошибку следующему обработчику:

```javascript

function (err, req, res, next) {
  if (req.xhr) {
    res.status(500).send({ error: 'Something failed!' })
  } else {
    next(err)
  }
}
```