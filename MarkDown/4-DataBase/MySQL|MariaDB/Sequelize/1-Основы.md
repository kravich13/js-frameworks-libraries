- [Sequelize](#sequelize)
  - [Подключение к БД](#подключение-к-бд)
    - [***Подключение к MySQL:***](#подключение-к-mysql)
  - [Определение моделей](#определение-моделей)
    - [***Сопоставление основных типов:***](#сопоставление-основных-типов)
    - [***Синхронизация с БД:***](#синхронизация-с-бд)
    - [***Удаление полей по дефолту:***](#удаление-полей-по-дефолту)
  - [Запросы к БД](#запросы-к-бд)
    - [***Добавление данных:***](#добавление-данных)
    - [***Получение данных:***](#получение-данных)
    - [***Простейшая фильтрация:***](#простейшая-фильтрация)
    - [***Получение одного объекта:***](#получение-одного-объекта)
    - [***Обновление:***](#обновление)
    - [***Удаление:***](#удаление)

# Sequelize

`Sequelize` - это библиотека для приложений на Node js, которая осуществляет сопоставление таблиц в бд и отношений между ними с классами.

При использовании `Sequelize` можно не писать SQL запросы, а работать с данными как с обычными объектами.

Установка пакета: `npm i sequelize`.
***
## Подключение к БД

Для подключения нужно создать объект `Sequelize`:

```javascript
const Sequelize = require("sequelize")
const sequelize = new Sequelize("nodejs", "root", "MYPASSWORD", {
    dialect: "mariadb",
    host: "localhost"
})
```

Функция `Sequelize` принимает ряд параметров: 1-й - имя БД, 2-й - логин, 3-й пароль. **4-й** параметр - объект, который принимает множество свойств:

* `dialect` - указывает одно из имён SQL: `mysql`, `mariadb`, `sqlite`, `postgres`, `mssql`.
* `host` - адрес, по которому запущен сервер.

### ***Подключение к MySQL:***

Для работы с MySQL обязательно нужно установить пакет `mysql2`.
***

## Определение моделей

Модели описывают структуру хранящихся в БД данных (таблицы).

Определение модели с помощью метода `define()`:

```javascript
const User = sequelize.define("Users", {
    Id: {
        type: Sequelize.INTEGER,
        autoIncrement: true,
        primaryKey: true,
        allowNull: false
    },
    Name: {
        type: Sequelize.STRING(20),
        allowNull: false
    },
    Age: {
        type: Sequelize.INTEGER,
        allowNull: false,
        defaultValue: 18 // значение по дефолту
    }
})
```

* 1-й параметр - название таблицы. Если её нет - создаётся, а в качестве имени будет применяться название во множественном числе (`s`).
* 2-й параметр - задаёт структуру таблицы (опись полей). Для каждого свои атрибуты, `type` - тип поля.

### ***Сопоставление основных типов:***

Синтаксис: `Sequaelize.тип`

| Тип в Sequelize | Возможный параметр | Тип по дефолту в SQL|
| --------- | ------------------ | ------------------- |
| .STRING | .STRING(30) | VARCHAR(255) |
| .STRING.BINARY | | VARCHAR BINARY |
| .TEXT | .TEXT("tiny") | TEXT |
| .INTEGER | | INTEGER |
| .FLOAT | .FLOAT(13, 2) | FLOAT |
| .DOUBLE | .DOUBLE(13, 2) | DOUBLE | 
| .DECIMAL | .DECIMAL(13, 2) | DECIMAL | 
|.DATE | .DATETIME(6) | DATETIME | 
|.DATEONLY | | DATE | 
| .BOOLEAN | | TINYINT(1) |


**Дополнительно** можно задать атрибут `allowNull`, который при `true` === `NULL`, а при `false` === `NOT NULL` и `defaultValue:` для значения по дефолту.

Атрибуты `autoIncrement` и `primaryKey` и **остальные** означают тоже самое, что и в SQL.

### ***Синхронизация с БД:***

Метод `sync()`, который возвращает промис, синхронизирует модель с таблицами БД.

* `Sequelize.sync({ timestamps: false })` - убрать поля `createdAt` и `updatedAt` по дефолту из модели. Для каждого поля по отдельности можно задать свой `false`.что таблицы в БД соответствуют определения в моделях. Для синхронизации выполняется метод `sync()`:

```javascript
sequelize.sync()
    .then(result => {
        // console.log(result)
    })
    .catch(err => console.log(err)) 
```

*Работа с конкретной моделью:*
* `User.sync()` - создаёт таблицу, если её нет и ничего с ней не делает, если она существует.
* `User.sync({ force: true })` - удаляет существующую таблицу и создаёт заново, если она не соответствует модели.
* `User.sync({ alter: true })` - проверяет состояние таблицы в БД (столбцы, тип данных и т.д.), а после **заменяет** таблицу на модель.
* `User.drop()` - удалить таблицу, которая относится к модели.

*Работа со всеми моделями:*
* Методы и суть работы та же, что и с конкретной моделью, но для указания всех моделей нужно указывать `sequelize.sync()`.
* `sequelize.drop` - удалить все таблицы.


### ***Удаление полей по дефолту:***

Поля `createdAt` и `updatedAt` установлены по дефолту, но их можно убрать, для этого в подключении к БД в `Sequelize` в объекте нужно указать `define: { timestamps: false }`.

Также можно указать для **одного** поля `true`, а для **второго** `false`:

```javascript
const Sequelize = require("sequelize")
const sequelize = new Sequelize("nodejs", "root", "MYPASSWORD", {
    dialect: "mysql",
    host: "localhost",
    define: {
        // timestamps: false - выкл всё
        // указывать с маленькой буквы для работоспособности
        createdAt: true, 
        updatedAt: false
    }
})

+----+------+-----------+-----+---------------------+
| Id | Name | FirstName | Age | createdAt           |
+----+------+-----------+-----+---------------------+
|  1 | Vlad | Kravich   |  23 | 2020-11-14 00:00:00 |
|  2 | Max  | Kravich   |  27 | 2020-11-14 00:00:00 |
+----+------+-----------+-----+---------------------+
```
***

## Запросы к БД

### ***Добавление данных:***

Для добавления данных в таблицу вызывается метод `create()`, в который передаётся передаваемый объект:

```javascript
User.create({
    Name: "Vlad",
    FirstName: "Kravich",
    Age: 23,
    CreatedAd: "2020-11-14"
})
```

После операции добавления данных можно получить добавленный объект, в том числе его `id` сгенерированный БД:

```javascript
User.create({
    Name: "Max",
    FirstName: "Kravich",
    Age: 27,
    CreateAd: "2020-11-13"
})
.then (res => {
    console.log(res) // получение данных о таблице Users
})
.catch (err => console.log(err))
```

### ***Получение данных:***

Для получения всех данных используется метод `findAll()`:

```javascript
User.findAll({ raw: true })
    .then(users => {
        console.log(users)
    })
    .catch(err => console.log(err))

// Данные возвращаются в виде массива объектов
```

В SQL терминале команда запроса фактически выглядит так:

```sql
SELECT `Id`, `Name`, `FirstName`, `Age`, `createdAt` 
FROM `Users` AS `Users`;
```

В метод `findAll()` передаётся необязательный объект `{ raw: true }`, который позволяет получить данные из самой таблицы в виде объектов (одна строка - один объект).

### ***Простейшая фильтрация:***

Для применения фильтрации (а **также** обновления и удаления) применяется `WHERE`. К примеру выберем всех пользователей с ником Max:

```javascript
User.findAll({ where: {name: "Max"}, raw: true })
    .then(users => {
        console.log(users)
    })
    .catch(err => console.log(err))
```

### ***Получение одного объекта:***

*Для получения одного объекта из БД можно применить следующие методы:*

* `findByPk()` - получает объект по первичному ключу.
* `findOne()` - получает один объект по определенному критерию.

```javascript
// Получение Id 2
User.findByPk(2)
.then(user => {
    if (!user) return // если пользователь не найден
    console.log(user.name)

}).catch(err => console.log(err))


// Получение имени Max
User.findOne({ where: {name: "Max"} })
.then(user => {
    if (!user) return // если пользователь не найден
    console.log(user.name)

}).catch(err => console.log(err))
```

### ***Обновление:***

Для обновления данных применяется метод `update()`, в который передаётся объект с новыми значениями и объектом выборки обновляемых объектов.

Обновим указанный в таблице возраст Макса до 23:

```javascript
User.update({ Age: 23 }, {
    where: {
        name: "Max"
    }
})
.then(users => {
    console.log(users)
})
.catch(err => console.log(err))
```

### ***Удаление:***

Для удаления используется метод `destroy()`, в который передаётся объект-критерий для удаления строки из БД:

```javascript
User.destroy({
    where: {
        name: "Vlad"
    }
})
.then(users => {
    console.log(users)
})
.catch(err => console.log(err))
```






