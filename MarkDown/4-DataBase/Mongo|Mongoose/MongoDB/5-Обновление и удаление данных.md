
- [Обновление и удаление данных](#обновление-и-удаление-данных)
  - [Обновление данных](#обновление-данных)
    - [***Метод update():***](#метод-update)
    - [***Обновление отдельного поля:***](#обновление-отдельного-поля)
    - [***Удаление поля:***](#удаление-поля)
    - [***updatedOne() и updateMany():***](#updatedone-и-updatemany)
    - [***Обновление массивов:***](#обновление-массивов)
    - [***Удаление элемента из массива:***](#удаление-элемента-из-массива)
  - [Удаление данных](#удаление-данных)
    - [***Удаление документов remove():***](#удаление-документов-remove)
    - [***Удаление коллекций и БД:***](#удаление-коллекций-и-бд)


# Обновление и удаление данных

## Обновление данных

Если обновляемых данных нет - они добавляются.

### ***Метод update():***

Метод `update()` принимает три параметра:

1. `query` - принимает запрос на выборку документа, который надо обновить
2. `objNew` - представляет документ с новой информацией, который заместит старый при обновлении
3. `options` - определяет доп. параметры при обновлении документов. Может принимать два аргумента: 
    * `upsert` - при значении `true` будет обновлять документ, если он найден и создавать новый, если такого нет. Если значение `false` - то новый документ создаваться не будет, если при выборке не будет найдено ни одного документа.
    * `multi` - указывате, должен ли обновляться первый элемент в выборке (юзается по **дефолту**) или же должны обновляться все документы в выборке.

```javascript
// Изменить документ Vlad на Vlad и изменить его зарплату с 2000 до 3000. 
// Если такого юзера нет - создать и присвоить переданные значения
db.users2.update({name : "Vlad"}, {name: "Vlad", salary: 3000}, {upsert: true})

// result operation: 1 найден, 0 добавлено и 1 изменён
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
```

### ***Обновление отдельного поля:***

Для изменения **отдельного** документа вместо всех документов коллекции применяется оператор `$set` (**`aggregate`**). Если документ не имеет обновляемого поля - оно создаётся.

```javascript
// Изменить документ Vlad с зп 3к на зп 2,5к
db.users2.update({ name: "Vlad", salary: 3000}, {$set: {salary: 2500}})
```

Если такого поля нет - добавить его: 

```javascript
db.users2.update(
    { name: "VladFuture", salary: 10000}, {$set: {plannedAge: 30}}
)
// { "name" : "VladFuture", "salary" : 10000, "plannedAge" : 30 }
```

При указании `multi: true` можно обновить **все** документы выборки, а не только лишь первый: 

```javascript
db.users2.update(
    { salary: 3000}, {$set: {age: 27}}, 
    { multi:true}
)

// { "name" : "Vlad", "salary" : 3000, "age" : 27 }
// { "name" : "Anna", "salary" : 3000, "age" : 27 }
```

Для **увеличения/уменьшения** на кол-во числовых единиц применяется оператор `$inc`. Если документ не содержит обновляемое поле, то оно создается:

```javascript
db.users2.update(
    { salary: 3000}, 
    {$inc: {age: -1}}, // уменьшить все найденные поля на 1. 27-1=26
    { multi:true}
)

// { "name" : "Vlad", "salary" : 3000, "age" : 26 }
// { "name" : "Anna", "salary" : 3000, "age" : 26 }
```

Для **умножения** поля на указанную сумму применяется `$mul`.

Для **переименования** поля применяется `$rename`.



### ***Удаление поля:***

Для удаления отдельного `key` используется оператор `$unset`:

```javascript
db.users2.update({ name : "Anna"}, {$unset: {age: 1}})
// { "name" : "Anna", "salary" : 3000 }
```

**Если** подобного `key` не существует, то оператор ничего не делает. Также можно удалить сразу несколько полей: 

```javascript
db.users2.update({ name : "Vlad"}, {$unset: {salary: 1, age: 1}})
```

### ***updatedOne() и updateMany():***

Метод `updateOne()` похож на метод `update()` за тем исключением, что он обновляет только **один** документ:

```javascript
db.users2.updateOne({ name : "Vlad", age: 26}, {$set: {salary: 3300}})
```

Если необходимо обновить **все** документы, соответствующие некоторому критерию, то применяется метод **updateMany()**:

```javascript
db.users2.updateMany({ salary: 3000}, {$set: {age : 27}})

// { "name" : "Vlad", "salary" : 3000, "age" : 27 }
// { "name" : "Anna", "salary" : 3000, "age" : 27 }
```

### ***Обновление массивов:***

* ### `$push`
    Добавляет в **конец** массива новый элемент:

    ```javascript
    db.users.updateOne({name : "Vlad"}, {$push: {languages: "Javascript"}})
    // { "languages" : [ "russian", "ukrainian", "Javascript" ] }
    ```

    Если `key` не представляет массив - выдаст ошибку: `Cannot apply $push/$pushAll modifier to non-array`.

    Используя оператор `$each` можно добавить сразу несколько значений:

    ```javascript
    db.users.update({name : "Vlad"}, 
    {$push: {languages: {$each: ["html", "nodejs"]}}})

    // { "languages" : [ "russian", "ukrainian", "Javascript", "html", "nodejs" ] }
    ```
    
    Оператор `$position` задаёт **позицию** в массиве для вставки элементов, а оператор `$slice` указывает, сколько элементов **оставить** в массиве после вставки:

    ```javascript
    // Начиная с индекса 2 добавить 2 элемента и оставить всего 5 элементов
    db.users.update({name : "Vlad"},
    {$push: {languages: 
    {$each: ["sql", "mongo"], $position: 2, $slice: 5}}})

    // { "name" : "Vlad", "languages" : 
    // [ "russian", "ukrainian", "sql", "mongo", "Javascript" ] }
    ```

* ### `$addToSet`
    Отличие `#addToSet` от `$push` в том, что `$addToSet` добавляет данные, если их еще нет в массиве:

    ```javascript
    db.users.update({ name : "Max", languages: [] }, {$addToSet: {languages: "english"}})

    // { "name" : "Max", "languages" : [ "english" ] }
    ```

### ***Удаление элемента из массива:***

* ### `$pop` 
    Позволяет удалить элемент из массива: 

    ```javascript
    db.users.update({ name : "Max", languages: ["russian"]}, {$pop: {languages: 1 || -1 }})

    // { "name" : "Max", "languages" : [ ] }
    ```

    * Указание `languages` значения `1` удаляет первый элемент с **конца** массива.
    * Для удаления **первого** элемента массива нужно передать `-1`.

    
* ### `$pull`
    Удаляет каждое вхождение элемента в массив. 
    
    * В массив можно добавить сколько угодно одинаковых значений и они не будут перезаписываться. 
    
    * Метод `$pull` удаляет все **повторяющиеся** элементы массива и оставляет **ничего**.

    ```javascript
    // Было 3 html, стало 0
    db.users.update({name : "Vlad"}, {$pull: {languages: "html"}})
    
    // "languages" : [ "russian", "ukrainian", "sql", "mongo", "Javascript", "nodejs", "nodejs", "nodejs" ]
    ```

* ### `$pullAll`

    Удаляет сразу **несколько** повторяющихся и нет переданных значений из массива: 

    ```javascript
    // Было 4 nodejs и 2 html, стало 0
    db.users.update({name : "Vlad"}, {$pullAll: {languages: ["html", "nodejs"]}})

    // "languages" : [ "russian", "ukrainian", "sql", "mongo", "Javascript" ]
    ```
***

## Удаление данных

### ***Удаление документов remove():***

Метод `remove()` удаляет абсолютно все найденные документы при совпадении:

```javascript
db.users.remove({ name : "Max", languages: "english"})
// удалит двух Максов сразу
```

При успешном удалении возвращает объект `WriteResult`:

```javascript
WriteResult({ "nRemoved" : 2 })
```

Также можно передать необязательный второй параметр `true`, который укажет на удаление лишь **одного** найдненного документа.

```javascript
db.users.remove({ name : "Max", languages: "english"}, true)
```

Для удаления  **всех** документов из коллекции нужно оставить пустым параметр запроса:

```javascript
db.users.remove( {} )
```

### ***Удаление коллекций и БД:***

Для удаления коллекции используется метод `drop()`:

```javascript
db.vlad.drop()
// При удалении вернёт true
```

Для удаления всей БД используется метод `dropDatabase()`:

```javascript
db.dropDatabase()
```
